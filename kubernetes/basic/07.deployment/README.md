# Deployment

A ```Deployment``` provides declarative updates for ```Pods``` and ```ReplicaSets```.
You describe a desired state in a Deployment, and the Deployment Controller changes the actual state to the desired
state at a controlled rate. You can define Deployments to create new ReplicaSets,
or to remove existing Deployments and adopt all their resources with new Deployments.
Each deployment, creates a replicaset which creates pods.

## example

```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

The following are typical use cases for ```Deployments```:

- Create a Deployment to rollout a ReplicaSet. The ReplicaSet creates Pods in the background. Check the status of the rollout to see if it succeeds or not.
- Declare the new state of the Pods by updating the PodTemplateSpec of the Deployment. A new ReplicaSet is created and the Deployment manages moving the Pods from the old ReplicaSet to the new one at a controlled rate. Each new ReplicaSet updates the revision of the Deployment.
- Rollback to an earlier Deployment revision if the current state of the Deployment is not stable. Each rollback updates the revision of the Deployment.
- Scale up the Deployment to facilitate more load.
- Pause the rollout of a Deployment to apply multiple fixes to its PodTemplateSpec and then resume it to start a new rollout.
- Use the status of the Deployment as an indicator that a rollout has stuck.
- Clean up older ReplicaSets that you don't need anymore.

The pod-template-hash label is added by the Deployment controller to every ReplicaSet that a Deployment creates or adopts.
This label ensures that child ReplicaSets of a Deployment do not overlap. It is generated by hashing the PodTemplate of the
ReplicaSet and using the resulting hash as the label value that is added to the ReplicaSet selector,
Pod template labels, and in any existing Pods that the ReplicaSet might have.

Remember that ```Deployments``` are stateless, meaning that they don't keep ```pvc``` or other pods resources after
they get terminated.

## commands

```shell
kubectl create -f deployment-definition.yml
```

```shell
kubectl get all
```

```shell
kubectl get deployments
```

```shell
kubectl create deployment httpd-frontend --image=httpd:2.4-alpine
kubectl scale deployment --replicas=3 httpd-frontend
```

## deploy strategies

- Rolling deployment—the default strategy that allows you to update a set of pods without downtime. It replaces pods running the old version of the application with the new version, one by one.
- Recreate deployment—an all-or-nothing method that lets you update an application instantly, with some downtime. It terminates all pods and replaces them with the new version.
- Ramped slow rollout—rolls out replicas of the new version, while in parallel, shutting down old replicas. 
- Best-effort controlled rollout—specifies a “max unavailable” parameter which indicates what percentage of existing pods can be unavailable during the upgrade, enabling the rollout to happen much more quickly.
- Blue/green deployment—a deployment strategy in which you create two separate, but identical environments, and over to the new environment.
- Canary deployment—uses a progressive delivery approach, with one version of the application serving most users, and another, newer version serving a small pool of test users. The test deployment is rolled out to more users if it is successful.
- Shadow deployment—the new version of the application (the “shadow” version) receives real-world traffic alongside the current version, but without affecting end-users.
- A/B testing—rolls out two or more versions of an application feature to a subset of users simultaneously to see which one performs better in terms of user engagement, error rates, or other KPIs.

## links

- [K8S deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)
- [Deployment strategies](https://spot.io/resources/kubernetes-autoscaling/5-kubernetes-deployment-strategies-roll-out-like-the-pros/)
- [2 phased Canary rollout](https://kubernetes.io/blog/2020/04/two-phased-canary-rollout-with-gloo/)
